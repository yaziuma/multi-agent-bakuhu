# 追加考察: トークン消費軽減を最優先にした改善策

## 方針
- 「YAMLが正データ」「ポーリング禁止」「指揮系統厳守」の前提は維持
- 読む量・書く量・復帰時の読み込み量を削減する
- 低コストで即効性のある施策を優先

---

## 低コスト・即効（設計/運用だけで効果）

### 1. YAMLスキーマの冗長削減
- **目的**: 読み込みトークン削減
- **方法**: `timestamp` や `parent_cmd` など未使用・低優先フィールドを省略許可
- **効果**: 各エージェントの読み込み量を直接削減

### 2. 軽量指示書（Lite版）の導入
- **目的**: セッション開始/復帰時の読み込み量削減
- **方法**: `instructions/*_lite.md` を用意し、復帰時はまず軽量版のみ読む
- **注意**: 禁止事項・指揮系統・正データルールは Lite版に必須で残す

### 3. 「最新のみ読む」運用
- **目的**: 古いレポートの読み込み回避
- **方法**: 家老/将軍は `queue/reports` の最新1件のみ読む
- **効果**: 進行中の過去ログ膨張を抑制

---

## 中コスト・高効果（小規模実装）

### 5. 報告サマリの別ファイル化
- **目的**: 家老が読む量を一定に保つ
- **方法**: 詳細報告は既存YAMLに維持し、
  `queue/reports/summary.yaml` に100〜200字要約を追記
- **運用**: 家老は通常 `summary.yaml` のみ読む

### 6. /clear 復帰の最小読込ルール徹底
- **目的**: 復帰時の読み込み量を最小化
- **方法**: まず `queue/tasks/ashigaruN.yaml` のみ読む、
  `project` がある場合のみ `context/{project}.md` を読む
- **効果**: 復帰コストを一定以下に抑える

### 7. テンプレート差分運用
- **目的**: 「全文記載」習慣の抑制
- **方法**: 変更点のみ記載する欄をテンプレート化し、未変更項目は省略

---

## 高コスト・高効果（必要時のみ）

### 8. watchdog 導入で読み込み頻度最適化
- **目的**: 変更時のみ読む（ポーリング禁止に沿う）
- **方法**: ファイル更新イベントをトリガーに読み込み
- **補足**: 既存のYAML+tmux運用は維持したまま堅牢化

### 9. ダッシュボード差分表示
- **目的**: 人間側の読む量削減
- **方法**: 直近更新のみ表示、履歴は別リンク

---

## 追加の運用ルール案（トークン節約に直結）

- **同じファイルを二度読まない**（読了済みフラグを運用で徹底）
- **完了タスクは即 /clear**（足軽は完了ごとに /clear を最優先）

---

## 方向性メモ: 「必要部分だけ抽出」の作り方（運用は毎回強制しない）

### イメージ
- **YAML/Markdownが明確にセクション分割されている場合**に限り、
  スクリプトで「必要部分だけを抽出して提示」できる。
- 毎回の運用で“それだけしか返さない”のではなく、
  **人間/家老が必要時に呼び出す補助ツール**として位置づける。

### 方向性（作り方）
- **YAML**: `read_scope` や `required_fields` を定義し、
  必要キーだけを抽出して表示する。
- **Markdown**: `## [READ_REQUIRED]` のようなラベル付きセクションを用意し、
  ラベル一致セクションのみを抽出する。

### 目的
- フル読みを禁止するのではなく、
  **「必要部分だけ素早く取り出せる道具」**としてコストを下げる。

## 推奨優先度

1. YAMLスキーマ削減
2. Lite指示書
3. 最新のみ読む運用
4. summary.yaml 方式
5. watchdog 導入
