# 伝令2専用タスクファイル
task:
  task_id: denrei_clear_compact_supplement
  parent_cmd: cmd_034
  priority: high
  description: |
    【補完調査】Claude Code /clear vs /compact 調査の欠落部分を補完せよ。

    ## 背景
    伝令1が忍びに依頼した調査報告（report_cmd_034_clear_compact.md）が
    53行で途中切断されている。セクション1〜3は取得できたが、
    セクション4〜6（コスト分析・最適化戦略・コミュニティ知見）が欠落。
    日本語版も欠落している。

    ## 調査項目（欠落部分のみ）

    ### セクション4: コスト分析 /clear vs /compact
    - /clear 後の復帰にかかる合計トークン数（CLAUDE.md再読み込み + YAML読み込み等）
    - /compact 後のsummaryサイズと復帰コスト
    - API課金への影響（入力トークン vs 出力トークンの比率）
    - 1日の運用で /clear 10回 vs /compact 5回 のコスト比較シミュレーション
    - どのような状況でどちらがコスト効率が良いか

    ### セクション5: マルチエージェント最適化戦略
    - 足軽型（短期・単一タスク）: /clear が有利な理由と運用パターン
    - 家老型（中期・複数タスク管理）: コンテキスト閾値別の最適戦略
    - 将軍型（長期・全体統括）: /compact 優先の理由と限界
    - Memory MCP を使ったコンテキスト永続化の具体的なパターン
      - 何をMemory MCPに保存すべきか
      - 何をYAMLに保存すべきか
      - 復帰時の読み込み順序の最適化
    - 「控えの家老」パターンの技術的実現可能性
      - 1つのtmuxペインで稼働する家老が倒れた時
      - 別ペインの控え家老にコンテキストを引き継ぐ方法
      - 状態のシリアライズ・デシリアライズのパターン

    ### セクション6: コミュニティの知見・公式情報
    - Claude Code の GitHub リポジトリ (anthropics/claude-code) の Issue/Discussion から:
      - コンテキスト管理に関する議論
      - /clear や /compact のバグ報告・改善要望
      - マルチエージェント利用者の知見
    - Anthropic 公式ブログ・ドキュメントの記載
    - 「claude code multi agent」「claude code context management」等で検索
    - 既知の制限事項・注意点

    ## Gemini CLI コマンド

    ```bash
    gemini -p "Claude Code /clear vs /compact: Supplementary Analysis (Sections 4-6)

    This is a SUPPLEMENTARY research to complete a partial report.
    The first 3 sections (command specs, context window) are already done.
    Focus ONLY on sections 4, 5, and 6 below.

    ## Section 4: Cost Analysis

    Provide a detailed cost comparison between /clear and /compact:

    1. Token Cost Breakdown:
       - /clear recovery cost: loading CLAUDE.md (~2000 tokens) + Memory MCP read (~700 tokens) + task YAML (~800 tokens) + instructions (~1500 tokens) = total recovery cost
       - /compact cost: summary generation (output tokens) + summary as input for next turn
       - Which approach uses more API tokens per cycle?

    2. Simulation:
       - Agent running for 8 hours, hitting context limits every 30 minutes
       - Scenario A: /clear every time (16 clears × recovery cost)
       - Scenario B: /compact 3 times then /clear (mix strategy)
       - Which is cheaper? Which preserves more useful context?

    3. Cost Efficiency Rules:
       - When is /clear more cost-effective?
       - When is /compact more cost-effective?
       - What is the optimal strategy for each agent type?

    ## Section 5: Multi-Agent Optimization Strategies

    For a system with these agent types:
    - Short-lived workers (ashigaru): execute single tasks, then idle
    - Medium-lived manager (karo): distribute tasks, collect reports, manage state
    - Long-lived orchestrator (shogun): oversee everything, make strategic decisions

    Provide specific strategies:
    1. For workers: Why /clear is preferred, optimal timing
    2. For manager: Context threshold management (60%/75%/85% rules)
    3. For orchestrator: /compact vs /clear decision tree
    4. Memory MCP patterns:
       - What to store in Memory MCP vs YAML files vs context
       - Optimal read order during recovery
       - Avoiding redundant data across layers
    5. Hot-standby pattern:
       - Can you hand off context from one Claude Code instance to another?
       - State serialization approaches (YAML, markdown summary)
       - Recovery protocol for standby agent activation

    ## Section 6: Community Knowledge

    Search for and report on:
    1. GitHub anthropics/claude-code issues about:
       - Context management
       - /clear and /compact behavior
       - Auto-compaction triggers and thresholds
       - Multi-agent or multi-session usage
    2. Blog posts and articles about Claude Code context optimization
    3. Known bugs, limitations, and workarounds
    4. Any upcoming features related to context management

    Be specific. Include URLs, issue numbers, and direct quotes where possible.
    Output in BOTH English and Japanese (日本語訳も含めよ).
    Format as clean markdown with clear section headers." 2>/dev/null > /home/quieter/projects/multi-agent-bakuhu/queue/shinobi/reports/report_cmd_034_clear_compact_supplement.md
    ```

    ## 結果保存先
    - queue/shinobi/reports/report_cmd_034_clear_compact_supplement.md

    ## 完了後
    1. 報告YAMLを作成: queue/denrei/reports/denrei2_report.yaml
    2. 家老ペイン (multiagent:0.0) に send-keys で報告
       ※ 将軍が直接確認するため、家老がビジーでも問題なし

  external_agent: shinobi
  status: assigned
  timestamp: "2026-02-06T03:15:00"
