# 伝令2専用タスクファイル
task:
  task_id: subtask_094_d2
  parent_cmd: cmd_094
  priority: critical
  description: |
    ## 概要
    cmd_094: _execute_body_direct 完全iterative化のため、軍師（Codex）に設計を依頼せよ。

    ## 背景
    殿が pyprolog を別環境でテストし、分析ドキュメントを作成された。
    docs/benchmark_heavy_timeout_analysis_ja.md に根本原因分析がある。
    3件のheavyベンチマーク全てで _execute_body_direct の HYBRID（再帰残存）が原因。

    ## 軍師（Codex）への設計依頼

    軍師の作業ディレクトリ: /home/quieter/projects/pyprolog/

    プロンプト:
    ```
    Design a FULL ITERATIVE conversion of _execute_body_direct for the pyprolog Prolog interpreter.

    CONTEXT:
    - Read docs/benchmark_heavy_timeout_analysis_ja.md for the problem analysis
    - Read pyprolog/runtime/logic_interpreter.py, focusing on:
      - _execute_body_direct (around line 973) - HYBRID implementation, has recursion remaining
      - _execute_conjunction_iterative (around line 1109) - already fully iterative (Phase 1 done)
      - _execute_single_goal (the function that _execute_body_direct dispatches to)
    - Read pyprolog/runtime/execution_frames.py for existing frame types

    YOUR TASKS:

    1. **COMPLETE RECURSION PATH MAPPING**: Identify EVERY recursive call path in and around _execute_body_direct:
       - _execute_body_direct → _execute_body_direct (disjunction, negation, if-then-else)
       - _execute_body_direct → _execute_single_goal → solve_goal_direct → _execute_body_direct
       - Any other indirect recursion paths
       Map each with exact line numbers.

    2. **DESIGN the full iterative conversion**:
       - Define new frame types needed (DisjunctionFrame, NegationFrame, IfThenElseFrame, etc.)
       - Design the main iteration loop that replaces all recursion
       - Show how conjunction (already iterative) integrates with the new design
       - Handle CutException propagation in the iterative model
       - Handle generator-based backtracking (yield) without recursion

    3. **CONCRETE CODE DESIGN**: For each recursive call site, show:
       - Current code (with line number)
       - Proposed replacement
       - How state is managed on the explicit stack

    4. **INTEGRATION with existing _execute_conjunction_iterative**:
       - The conjunction iterative implementation currently calls _execute_body_direct recursively
       - Show how to merge conjunction iteration into the unified iterative loop

    5. **TEST PLAN**: Which tests validate the conversion? Expected behavior changes?

    6. **RISK ANALYSIS**: What could break? Edge cases to watch for?

    Output in Japanese. Do not include thinking process. Output only the final result.
    ```

    報告先: queue/gunshi/reports/report_cmd_094_body_direct_design.md

    ## 手順
    1. 軍師（Codex）を召喚し、上記プロンプトで設計依頼を実行
    2. 報告を queue/gunshi/reports/report_cmd_094_body_direct_design.md に保存
    3. 完了報告を書いて家老を起こせ

    ## 報告
    queue/denrei/reports/denrei2_report.yaml に完了報告を記載し、家老を起こせ。
    家老ペイン: multiagent:agents.0

  external_agent: gunshi
  status: pending
  timestamp: "2026-02-10T01:50:00"
