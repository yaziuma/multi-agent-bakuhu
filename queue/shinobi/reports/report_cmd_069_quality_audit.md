マルチエージェントシステム品質監査報告書

**監査日**: 2026年2月8日
**監査対象**: Ashigaru（足軽）エージェント群によるタスク遂行品質
**対象コマンド**: `cmd_061` - `cmd_068` (shogun-webプロジェクト)

## 1. 総括

`cmd_061`から`cmd_068`に至る一連のタスクにおいて、複数回の設計変更、バグ混入、そして最終的な完全な差し戻し（Full Revert）が発生した。これは、指示品質、実装品質、レビュープロセス、テストカバレッジ、およびコンテキスト管理の各側面に根深い問題を抱えていることを示唆している。本報告書では、5つの観点から問題の根本原因を分析し、再発防止策を提言する。

---

## 2. 監査結果詳細

### 2.1. 指示品質 (Instruction Quality)

`cmd_061`から`cmd_067`における一連の指示は、最終目的（ユーザー入力のハイライト）は一貫していたものの、その実現手段が複数回にわたり変転しており、一貫した技術的アプローチが提示されていなかった。

*   **問題点**:
    *   **方針の不在**: 家老（Karo）は将軍（Shogun）の指示を「目的」として受け取り、最適な実行計画を「自ら設計する」責務を負う（`instructions/karo.md`）。しかし、`cmd_065`（デリミタペア方式）、`cmd_066`（送信テキストキャッシュ照合方式）、`cmd_067`（再度デリミタペア方式）と実装方針が二転三転していることから、家老がタスク着手前に十分な技術的検討と設計を行わず、場当たり的な指示を出していた可能性が高い。
    *   **詳細度の不備**: 初期指示 (`cmd_061`) において、クリーンアップ処理の対象範囲に関する詳細な仕様が欠落していた。これにより、足軽は「ユーザー入力（`❯`で始まる行）を削除してはならない」という重要な制約を認識できず、過度に広範な正規表現を実装するに至った。

*   **提言**:
    *   **家老の設計責任の徹底**: 家老は、足軽にタスクを割り当てる前に、複数の実装アプローチを比較検討し、最適な設計を決定してから具体的な指示書（YAML）を作成すべきである。特にUI操作のような副作用の大きい変更については、より慎重な事前設計が求められる。
    *   **完了条件の明確化**: 指示書には、実装内容だけでなく、「守るべきこと」（制約条件）と「壊してはいけないこと」（非機能要件）を明記する。例えば、「ユーザーが入力したテキストは、いかなる場合も表示から消えないこと」といった具体的な受け入れ基準を設ける。

### 2.2. 実装品質 (Implementation Quality)

足軽（Ashigaru）エージェントの実装には、複数の具体的な誤りが見られた。

*   **問題点**:
    *   **過度に広範な正規表現 (`cmd_061`)**: `_clean_output()` 関数で実装された正規表現が、意図せずユーザー入力行までマッチしてしまい、削除する結果となった。これは、入力データパターンの多様性に対する想定が不足していたことに起因する。
    *   **設計の頻繁な変更（Flip-Flopping）**: 短期間に3回もコアロジックの設計が変更されている。これは、前回の実装の問題点を十分に分析せずに次のタスクに着手していることを示唆する。特に `cmd_065` から `cmd_067` で同じアプローチに回帰している点は、非効率の極みである。
    *   **繰り返し発生するファイル修正**: 同一ファイル群が複数回にわたり書き換えられている。これは、タスクの試行錯誤が本番コード上で直接行われていたことを示しており、品質管理上、極めて危険な状態であった。

*   **提言**:
    *   **ペルソナ設定の徹底**: 足軽は作業開始時に「シニアソフトウェアエンジニア」等のペルソナを設定するよう指示されている。正規表現のような影響範囲の広いコードを実装する際は、より慎重なペルソナ（例: 「防御的プログラミングを実践するベテランエンジニア」）として、エッジケースを考慮するよう家老が指示すべきである。
    *   **セルフレビューの義務化**: 足軽はコード変更後、`Read` ツールで自らの変更を読み返し、意図通りの修正になっているか確認するプロセスを徹底させる。

### 2.3. レビュープロセス (Review Process)

家老による品質ゲートが機能していなかった。

*   **問題点**:
    *   **品質検収プロセスの形骸化**: `instructions/karo.md` には `ruff check`, `ruff format`, `pytest` を実行する「コード品質検収プロセス」が明記されている。しかし、`cmd_061`で本番障害につながるバグが混入し、それが `cmd_062` で「完了」として報告されたことから、家老がこの検収プロセスを怠っていたか、プロセス自体が不十分であったことは明らかである。
    *   **完了報告の即時承認**: 足軽からの完了報告を、家老が内容をレビューせずにそのまま将軍へ報告していた。`instructions/karo.md`のワークフローでは、足軽からの報告を受けて `dashboard.md` を更新するステップがあるが、その前に成果物を検証するステップが明示的に定義されていない（検収プロセスは別記）。

*   **提言**:
    *   **検収プロセスの厳格な執行**: 家老は、足軽からの完了報告を受けた際、`dashboard.md` を更新する前に、必ず「コード品質検収プロセス」を実行するワークフローを徹底する。
    *   **機能的レビューの追加**: 静的解析や単体テストに加え、家老自身（または別の足軽）が「QAエンジニア」ペルソナで、実際の動作を確認するステップ（手動テストまたはPlaywright等を用いたE2Eテスト）を品質ゲートに組み込む。特にUIに関わる変更では必須とすべきである。

### 2.4. テストカバレッジ (Test Coverage)

テストはパスしていたにも関わらず、本番環境でバグが露呈した。これはテストスイートの質に問題があることを示している。

*   **問題点**:
    *   **エッジケースの欠如**: `cmd_061` のバグを見逃したことから、既存のテストケースには「`❯` 記号で始まるユーザー入力」のような、正規表現が誤ってマッチする可能性のあるパターンが含まれていなかった。正常系シナリオしかカバーできておらず、異常系や境界値のテストが不足していた。
    *   **リグレッションテストの不足**: `cmd_063` 以降の修正で、新たなバグが発生していないことを確認するためのリグレッションテストが不十分であった。設計変更のたびに、既存機能が破壊されていないかを確認する仕組みがなかった。

*   **提言**:
    *   **バグ駆動テスト (Bug-Driven Testing)**: 発見されたバグは、必ずそれを再現するテストケースとして恒久的にテストスイートに追加する。今回のケースでは、「`❯ input text` という文字列を含む出力が、`_clean_output` を通しても削除されないこと」を検証するテストを追加すべきである。
    *   **テストペルソナの導入**: 家老はタスク指示時に、実装担当の足軽とは別に、「QAエンジニア」ペルソナの足軽をアサインし、実装と並行してテストケースを作成・拡充させることを検討する。

### 2.5. コンテキスト管理 (Context Management)

足軽のコンテキスト管理戦略が、連続的なタスクの品質を著しく低下させた。

*   **問題点**:
    *   **不適切な `/clear` の使用**: `instructions/ashigaru.md` は、レート制限緩和やコンテキスト汚染防止のため、タスク完了後の `/clear` を推奨している。しかし、`cmd_061`→`cmd_063`→`cmd_065` のような密接に関連する一連の修正タスク間で `/clear` を実行すると、前回のタスクで得た知見（「なぜこの正規表現はダメだったのか」「次はこのアプローチを試そうとした」等）が完全に失われる。これにより、足軽は毎回ゼロから思考を始めることになり、設計の迷走や同じ過ちの繰り返しにつながった。
    *   **家老の判断ミス**: `instructions/karo.md` には、「同一プロジェクト・同一ファイル群の連続タスク」の場合に `/clear` をスキップする `skip_clear` という例外ルールが存在する。今回の一連のタスクはまさにこのケースに該当するが、家老はこのルールを適用せず、機械的に `/clear` を指示していた。これは家老の状況判断能力の欠如を示している。

*   **提言**:
    *   **コンテキスト引き継ぎルールの強化**: 関連する連続タスクの場合、家老は `/clear` を禁止し、代わりに前タスクの報告書（特に失敗理由や次のアプローチ案）を次タスクの指示書に含めることを義務付ける。
    *   **`progress`フィールドの活用**: `instructions/ashigaru.md` には、タスクが途中で中断される場合に備え、`progress` フィールドに途中状態を記録する仕様がある。これを応用し、連続タスクの際にも前回の状態をこのフィールドに記録・引き継がせる運用を検討する。

---
## 3. 結論と今後の対策

今回の一連の品質問題は、単一のエージェントの失敗ではなく、指示・実装・レビュー・テスト・コンテキスト管理という開発サイクル全体にわたる複合的な欠陥によって引き起こされた。特に、**家老エージェントが戦略的設計と品質ゲートの責任者として機能不全に陥っていたこと**、そして**タスクの性質を考慮しない機械的なコンテキストリセットが、足軽の学習と連続的改善を妨げたこと**が最大の原因である。

将軍におかれては、家老に対し、本報告書で提言された対策（特に**事前設計の徹底**、**品質検収の厳格化**、**状況に応じたコンテキスト管理**）を即時実行させるよう厳命されたい。

以上
