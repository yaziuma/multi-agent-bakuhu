# コンテキスト健康管理 詳細リファレンス

> CLAUDE.md から分離。閾値テーブルは CLAUDE.md に残存。
> 詳細戦略・テンプレート・混合戦略はこちらを参照。

## /compact カスタム指示（全エージェント必須知識）

`/compact` はカスタム指示付きで実行できる。これにより要約時に保持すべき情報を指定可能。

**構文**: `/compact <保持すべき情報の指示>`

**エージェント別テンプレート**:

| エージェント | /compact テンプレート |
|-------------|---------------------|
| **将軍** | `/compact 殿からの現在の指示、進行中プロジェクト一覧、未解決の要対応事項を必ず保持せよ` |
| **家老** | `/compact 進行中タスク一覧、各足軽の状態、未処理報告、compact回数カウンタを必ず保持せよ` |
| **足軽** | `/compact 現在のタスクID、対象ファイル、実装方針、未完了項目を必ず保持せよ` |

**重要**: カスタム指示なしの `/compact` は汎用要約となり、重要な状態情報が失われる可能性がある。**必ずカスタム指示付きで実行せよ。**

## /clear vs /compact の使い分け

| 条件 | 推奨 | 理由 |
|------|------|------|
| タスク完了後 | /clear | コンテキストを完全リセット |
| タスク途中で75%到達 | /compact（カスタム指示付き） | 作業継続のためsummary保持 |
| 同一プロジェクトの連続タスク | /compact | 前タスクのコンテキストが有用 |
| 異なるプロジェクトのタスク切替 | /clear | 前コンテキストが汚染源になる |

## 家老の混合戦略（3回compact → 1回clear）

家老は以下のサイクルでコンテキストを管理せよ：

```
compact回数カウンタ = 0 で運用開始
  │
  ▼ 60-75%到達
  │   カウンタ < 3 → /compact（カスタム指示付き）、カウンタ++
  │   カウンタ >= 3 → /clear、カウンタ = 0
  │
  ▼ 85%到達（緊急時）
  │   カウンタに関わらず /clear、カウンタ = 0
```

**コスト根拠**: 忍び調査（cmd_034）により、純粋/clear戦略（80,000トークン/サイクル）に対し混合戦略（56,000トークン/サイクル）は約30%のコスト削減効果がある。

## 家老の健康監視責任

家老は全エージェントの健康状態を監視する責任を負う。以下を実施せよ：

1. **タスク分配完了時**: 自身のコンテキストを確認し、60%超なら /compact（カスタム指示付き）
2. **足軽タスク完了時**: 足軽に /clear を送信
3. **長時間作業中の足軽**: 進捗確認時にコンテキスト状況も確認
